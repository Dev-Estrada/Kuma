<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KUMA - Configuraci√≥n</title>
  <link rel="icon" href="/assets/logo.png" type="image/png" />
  <link rel="stylesheet" href="/css/styles.css" />
  <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');</script>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar__row topbar__row--first">
        <div class="topbar__left">
          <a href="/index.html" class="topbar__brand">
            <img src="/assets/logo.png" alt="KUMA" class="topbar__logo" />
            <span>KUMA</span>
          </a>
          <span id="topbar-welcome" class="topbar__welcome"></span>
        </div>
        <div class="topbar__right">
          <div class="topbar__notifications-wrap">
            <button type="button" class="topbar__notifications-btn" id="btn-notifications" aria-label="Notificaciones">
              <span class="topbar__notifications-icon">üîî</span>
              <span class="topbar__notifications-badge" id="notifications-badge" style="display:none;">0</span>
            </button>
            <div class="notifications-dropdown" id="notifications-dropdown">
              <div class="notifications-dropdown__header">Notificaciones</div>
              <div class="notifications-dropdown__list" id="notifications-list"></div>
            </div>
          </div>
          <span id="nav-auth"></span>
        </div>
      </div>
      <nav class="topbar__nav">
        <a class="topbar__link" href="/index.html">Inicio</a>
        <a class="topbar__link" href="/pages/sales.html">Punto de venta</a>
        <a class="topbar__link" href="/pages/inventory.html">Inventario</a>
        <a class="topbar__link" href="/pages/sales-history.html">Ventas</a>
        <a class="topbar__link" href="/pages/reports.html">Reportes</a>
        <a class="topbar__link" href="/pages/clients.html">Clientes</a>
        <a class="topbar__link active" href="/pages/settings.html">Configuraci√≥n</a>
      </nav>
    </header>
    <main class="main">
      <h1 class="page-title">Configuraci√≥n</h1>
      <div class="controls-bar" style="margin-bottom: 1rem;">
        <button type="button" class="btn btn--ghost" id="btn-settings-appearance">Apariencia</button>
        <button type="button" class="btn btn--ghost" id="btn-settings-rate">Tasa de cambio</button>
        <button type="button" class="btn btn--ghost settings-btn--admin-only" id="btn-settings-backup">Copia de seguridad</button>
        <button type="button" class="btn btn--ghost settings-btn--admin-only" id="btn-settings-restore">Restaurar desde copia</button>
        <button type="button" class="btn btn--ghost settings-btn--admin-only" id="btn-settings-demo">Base de datos demo</button>
        <button type="button" class="btn btn--ghost settings-btn--admin-only" id="btn-settings-delete-db">Eliminar BD actual</button>
        <button type="button" class="btn btn--ghost settings-btn--admin-only" id="btn-settings-auto-backup">Copia autom√°tica</button>
      </div>

      <div class="card">
        <div class="card__title">Historial de tasa de cambio (auditor√≠a)</div>
        <p class="text-muted" style="margin: 0 0 .75rem;">Registro de cada cambio de tasa con fecha y hora.</p>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Tasa (Bs/USD)</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody id="rate-history-tbody"></tbody>
          </table>
        </div>
        <div class="table-pagination" id="rate-history-pagination"></div>
        <p class="text-muted mt-1 mb-0" id="rate-history-msg">Cargando‚Ä¶</p>
      </div>
    </main>
  </div>

  <!-- Modal: Apariencia -->
  <div id="settings-modal-appearance" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 26rem;">
      <h2 class="modal__title">Apariencia</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Cambia entre tema claro y oscuro.</p>
      <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema">
        <span id="theme-toggle-label">Modo oscuro</span>
      </button>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-appearance">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Tasa de cambio -->
  <div id="settings-modal-rate" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Tasa de cambio (USD ‚Üí Bs)</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Los precios se guardan en d√≥lares. Esta tasa se usa para mostrar totales en bol√≠vares en el punto de venta. Cada cambio queda registrado en el historial para auditor√≠a.</p>
      <div class="form-group">
        <label for="exchange-rate">Tasa actual (Bs por 1 USD)</label>
        <input type="number" id="exchange-rate" min="0.01" step="0.01" placeholder="36.50" />
      </div>
      <div class="form-group">
        <label for="rate-notes">Nota (opcional, para auditor√≠a)</label>
        <input type="text" id="rate-notes" placeholder="Ej: Tasa BCV 23/02/2025" />
      </div>
      <div class="form-row mt-1">
        <button type="button" class="btn btn--primary" id="btn-save-rate">Guardar tasa</button>
      </div>
      <div id="settings-msg"></div>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-rate">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Copia de seguridad -->
  <div id="settings-modal-backup" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Copia de seguridad</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Descarga una copia del archivo de base de datos (inventory.db) para respaldo.</p>
      <a href="/api/backup" class="btn btn--ghost" id="btn-backup" download="inventory.db">Descargar copia de seguridad</a>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-backup">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Restaurar desde copia -->
  <div id="settings-modal-restore" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Restaurar desde copia</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Sube un archivo .db (copia de seguridad o <strong>demoBD.db</strong>). La restauraci√≥n se aplicar√° al <strong>reiniciar el servidor</strong>. Se guardar√° una copia de la base actual como inventory.db.bak.</p>
      <div class="form-group">
        <label for="restore-file">Seleccionar archivo (.db)</label>
        <input type="file" id="restore-file" accept=".db,application/octet-stream" />
      </div>
      <button type="button" class="btn btn--primary" id="btn-restore" disabled>Restaurar (aplicar al reiniciar)</button>
      <p id="restore-msg" class="text-muted mt-1 mb-0" style="display:none;"></p>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-restore">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Base de datos demo -->
  <div id="settings-modal-demo" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Base de datos de demostraci√≥n</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Carga la base de datos <strong>demoBD.db</strong> con productos, ventas y clientes de ejemplo. Reinicie el servidor despu√©s para aplicarla.</p>
      <button type="button" class="btn btn--ghost" id="btn-restore-demo">Cargar base de datos de demostraci√≥n</button>
      <p id="restore-demo-msg" class="text-muted mt-1 mb-0" style="display:none;"></p>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-demo">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Eliminar BD actual -->
  <div id="settings-modal-delete-db" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Eliminar base de datos actual</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Borra la base de datos actual. √ötil si est√° da√±ada. Despu√©s puede restaurar desde una copia o cargar la demo. Se crear√° una base de datos nueva vac√≠a (usuario admin / Admin123!).</p>
      <button type="button" class="btn btn--ghost btn--danger" id="btn-delete-db">Eliminar base de datos actual</button>
      <p id="delete-db-msg" class="text-muted mt-1 mb-0" style="display:none;"></p>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-delete-db">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Copia autom√°tica -->
  <div id="settings-modal-auto-backup" class="overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal" style="max-width: 28rem;">
      <h2 class="modal__title">Copia de seguridad autom√°tica</h2>
      <p class="text-muted" style="margin: 0 0 1rem;">Todos los d√≠as a las <strong>23:59</strong> (hora Venezuela) se guarda una copia en la carpeta <strong>backups/</strong>. Se mantienen como m√°ximo <strong>7 copias</strong>; las m√°s antiguas se eliminan.</p>
      <div class="modal__actions" style="margin-top: 1rem;">
        <button type="button" class="btn btn--ghost" data-settings-close="settings-modal-auto-backup">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('keydown', function(e) {
      if (!e.ctrlKey) return;
      if (e.key === '1') { e.preventDefault(); location.href = '/index.html'; }
      if (e.key === '2') { e.preventDefault(); location.href = '/pages/sales.html'; }
      if (e.key === '3') { e.preventDefault(); location.href = '/pages/inventory.html'; }
      if (e.key === '4') { e.preventDefault(); location.href = '/pages/sales-history.html'; }
      if (e.key === '5') { e.preventDefault(); location.href = '/pages/reports.html'; }
      if (e.key === '6') { e.preventDefault(); location.href = '/pages/clients.html'; }
      if (e.key === '8') { e.preventDefault(); location.href = '/pages/settings.html'; }
    });
  </script>
  <div id="alert-modal-root"></div>
  <script src="/js/auth/auth.js"></script>
  <script src="/js/auth/auth-nav.js"></script>
  <script src="/js/shared/print-utils.js"></script>
  <script src="/js/shared/alerts-notifications.js"></script>
  <script type="module" src="/js/pages/settings.js"></script>
</body>
</html>
